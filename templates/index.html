{{define "content"}}
<form id="bulk-actions-form" method="POST" action="/bookmark/delete-selected"></form>
<form id="bulk-move-form" method="POST" action="/bookmark/move"></form>

<!-- æœç´¢æ  -->
<div class="search-bar">
    <form method="GET" action="/" id="search-form" class="search-bar-form">
        <input type="text" name="q" id="search-input" placeholder="æœç´¢ä¹¦ç­¾..." value="{{.Search}}">
        {{if .PageSizeParam}}
        <input type="hidden" name="size" value="{{.PageSizeParam}}">
        {{end}}
        {{if .SortBy}}
        <input type="hidden" name="sort" value="{{.SortBy}}">
        {{end}}
        <button type="submit" class="btn btn-primary">æœç´¢</button>
    </form>
</div>

<div class="page-header">
    <div class="header-left">
        <h1>
            {{if .CurrentTag}}
            <span class="tag-badge" style="background-color: {{.CurrentTag.Color}}">{{.CurrentTag.Name}}</span>
            {{else if .Search}}
            æœç´¢: "{{.Search}}"
            {{else if .CurrentFolderName}}
            æ–‡ä»¶å¤¹: "{{.CurrentFolderName}}"
            {{else}}
            å…¨éƒ¨æ”¶è—
            {{end}}
        </h1>
        <span class="bookmark-count">å…± {{.Total}} æ¡</span>
    </div>
    <div class="header-right">
        <div class="header-actions">
            <button type="button" class="btn btn-primary" id="btn-quick-add">+ æ·»åŠ </button>
            <a href="/bookmark/export" class="btn btn-outline">å¯¼å‡º</a>
            <button type="button" class="btn btn-outline" id="load-favicons">åŠ è½½å›¾æ ‡</button>
            <button type="button" class="btn btn-outline" id="select-page">å…¨é€‰æœ¬é¡µ</button>
            <button type="submit" class="btn btn-outline btn-danger" id="delete-selected" form="bulk-actions-form" disabled>åˆ é™¤é€‰ä¸­</button>
            <button type="button" class="btn btn-outline" id="move-selected" disabled>ç§»åŠ¨é€‰ä¸­</button>
            {{if not .IsAllFolders}}
            <form method="POST" action="/bookmark/clear-folder" class="inline-form" id="clear-folder-form">
                <input type="hidden" name="folder" value="{{.FolderParam}}">
                <button type="submit" class="btn btn-outline btn-danger">
                    {{if .IsRootFolder}}åˆ é™¤æœªåˆ†ç±»{{else}}åˆ é™¤å½“å‰æ–‡ä»¶å¤¹{{end}}
                </button>
            </form>
            {{end}}
            <form method="POST" action="/bookmark/clear" class="inline-form">
                <button type="submit" class="btn btn-outline btn-danger" id="clear-all-bookmarks">æ¸…ç©ºå…¨éƒ¨</button>
            </form>
        </div>
    </div>
</div>

<!-- ç§»åŠ¨ä¹¦ç­¾å¼¹çª— -->
<div id="move-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹</h3>
        <input type="text" id="target-folder-input" placeholder="è¾“å…¥ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆç•™ç©ºä¸ºæ ¹ç›®å½•ï¼‰" class="form-input">
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" id="cancel-move">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="confirm-move">ç¡®å®šç§»åŠ¨</button>
        </div>
    </div>
</div>

<!-- FaviconåŠ è½½è¿›åº¦å¼¹çª— -->
<div id="favicon-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>åŠ è½½ç½‘ç«™å›¾æ ‡</h3>
        <div class="favicon-progress">
            <span id="favicon-current">0</span> / <span id="favicon-total">0</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="favicon-progress-bar" style="width: 0%"></div>
        </div>
        <p id="favicon-status">å‡†å¤‡ä¸­...</p>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" id="minimize-favicon">åå°è¿è¡Œ</button>
            <button type="button" class="btn btn-danger" id="cancel-favicon">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- åå°åŠ è½½è¿›åº¦æ¡ -->
<div id="favicon-float" class="favicon-float" style="display:none;">
    <div class="favicon-float-header">
        <span>åŠ è½½å›¾æ ‡</span>
        <button type="button" id="expand-favicon" title="å±•å¼€">+</button>
    </div>
    <div class="favicon-float-progress">
        <span id="favicon-float-text">0/0</span>
        <div class="progress-bar">
            <div class="progress-fill" id="favicon-float-bar" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- ç§»åŠ¨æ–‡ä»¶å¤¹ç¡®è®¤å¼¹çª— -->
<div id="folder-move-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>ç§»åŠ¨æ–‡ä»¶å¤¹</h3>
        <p id="folder-move-message"></p>
        <p class="folder-move-hint">ç§»åŠ¨ï¼šä¿ç•™æ–‡ä»¶å¤¹ç»“æ„<br>åˆå¹¶ï¼šå°†å†…å®¹ç›´æ¥æ”¾å…¥ç›®æ ‡æ–‡ä»¶å¤¹</p>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" id="cancel-folder-move">å–æ¶ˆ</button>
            <button type="button" class="btn btn-outline" id="merge-folder-move">åˆå¹¶</button>
            <button type="button" class="btn btn-primary" id="confirm-folder-move">ç§»åŠ¨</button>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿæ·»åŠ å¼¹çª— -->
<div id="quick-add-modal" class="modal" style="display:none;">
    <div class="modal-content quick-add-modal">
        <h3>æ·»åŠ åˆ°: <span id="quick-add-folder-name">æ ¹ç›®å½•</span></h3>
        <div class="quick-add-tabs">
            <button type="button" class="tab-btn active" data-tab="bookmark">æ·»åŠ æ”¶è—</button>
            <button type="button" class="tab-btn" data-tab="folder">æ·»åŠ æ–‡ä»¶å¤¹</button>
        </div>
        <div class="tab-content" id="tab-bookmark">
            <div class="form-group">
                <label>URL <span class="required">*</span></label>
                <input type="text" id="quick-add-url" placeholder="https://example.com" class="form-input">
            </div>
            <div class="form-group">
                <label>æ ‡é¢˜ï¼ˆç•™ç©ºè‡ªåŠ¨è·å–ï¼‰</label>
                <input type="text" id="quick-add-title" placeholder="ç½‘é¡µæ ‡é¢˜" class="form-input">
            </div>
        </div>
        <div class="tab-content" id="tab-folder" style="display:none;">
            <div class="form-group">
                <label>æ–‡ä»¶å¤¹åç§°</label>
                <input type="text" id="quick-add-folder-input" placeholder="æ–°å»ºæ–‡ä»¶å¤¹" class="form-input">
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" id="cancel-quick-add">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="confirm-quick-add">ç¡®å®š</button>
        </div>
    </div>
</div>

<div class="content-wrapper">
    <aside class="sidebar">
        <div class="sort-box">
            <label>æ’åºï¼š</label>
            <select id="sort-select" onchange="applySort(this.value)">
                <option value=""{{if eq .SortBy ""}} selected{{end}}>é»˜è®¤ï¼ˆæ—¶é—´å€’åºï¼‰</option>
                <option value="time_desc"{{if eq .SortBy "time_desc"}} selected{{end}}>æ—¶é—´ â†“</option>
                <option value="time_asc"{{if eq .SortBy "time_asc"}} selected{{end}}>æ—¶é—´ â†‘</option>
                <option value="title_asc"{{if eq .SortBy "title_asc"}} selected{{end}}>æ ‡é¢˜ A-Z</option>
                <option value="title_desc"{{if eq .SortBy "title_desc"}} selected{{end}}>æ ‡é¢˜ Z-A</option>
                <option value="url_asc"{{if eq .SortBy "url_asc"}} selected{{end}}>URL A-Z</option>
                <option value="url_desc"{{if eq .SortBy "url_desc"}} selected{{end}}>URL Z-A</option>
            </select>
        </div>

        <div class="folder-tree">
            <h3>æ–‡ä»¶å¤¹</h3>
            <ul class="folder-tree-list">
                <li class="folder-tree-node {{if .IsAllFolders}}open{{end}}">
                    <div class="folder-tree-row">
                        <span class="folder-caret empty"></span>
                        <a href="/{{if .PageSizeParam}}?size={{.PageSizeParam}}{{end}}" class="folder-link {{if .IsAllFolders}}active{{end}}">å…¨éƒ¨</a>
                    </div>
                </li>
                {{if .HasUncategorized}}
                <li class="folder-tree-node {{if .IsRootFolder}}open{{end}}">
                    <div class="folder-tree-row">
                        <span class="folder-caret empty"></span>
                        <a href="/?folder=__root__{{if .PageSizeParam}}&size={{.PageSizeParam}}{{end}}" class="folder-link {{if .IsRootFolder}}active{{end}}">æœªåˆ†ç±»</a>
                    </div>
                </li>
                {{end}}
                {{template "folder_nodes" .FolderTree}}
            </ul>
        </div>

        <div class="tag-cloud">
            <h3>æ ‡ç­¾</h3>
            <div class="tag-list">
                <a href="/{{if .PageSizeParam}}?size={{.PageSizeParam}}{{end}}" class="tag-item {{if not .CurrentTag}}active{{end}}">å…¨éƒ¨</a>
                {{range .Tags}}
                <a href="/?tag={{.ID}}{{if $.PageSizeParam}}&size={{$.PageSizeParam}}{{end}}" class="tag-item" style="--tag-color: {{.Color}}">
                    {{.Name}} <span class="tag-count">{{.Count}}</span>
                </a>
                {{end}}
            </div>
        </div>
    </aside>

    <div class="bookmark-list">
        {{if .Bookmarks}}
        {{range .Bookmarks}}
        <div class="bookmark-card">
            <div class="bookmark-select">
                <input type="checkbox" name="ids" value="{{.ID}}" class="bookmark-select-input" form="bulk-actions-form">
            </div>
            <div class="bookmark-favicon">
                <img src="{{.Favicon}}" alt="" onerror="this.src='/static/img/default-favicon.png'">
            </div>
            <div class="bookmark-content">
                <h3 class="bookmark-title">
                    <a href="{{.URL}}" target="_blank" rel="noopener">{{.Title}}</a>
                </h3>
                <p class="bookmark-url">{{.URL}}</p>
                {{if .Description}}
                <p class="bookmark-desc">{{.Description}}</p>
                {{end}}
                <div class="bookmark-meta">
                    <div class="bookmark-tags">
                        {{range .Tags}}
                        <a href="/?tag={{.ID}}{{if $.PageSizeParam}}&size={{$.PageSizeParam}}{{end}}" class="mini-tag" style="background-color: {{.Color}}">{{.Name}}</a>
                        {{end}}
                    </div>
                    <span class="bookmark-date">{{.CreatedAt.Format "2006-01-02"}}</span>
                </div>
            </div>
            <div class="bookmark-actions">
                <a href="/bookmark/edit?id={{.ID}}" class="btn-icon" title="ç¼–è¾‘">âœï¸</a>
                <a href="/bookmark/delete?id={{.ID}}" class="btn-icon btn-danger" title="åˆ é™¤" onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ”¶è—å—ï¼Ÿ')">ğŸ—‘ï¸</a>
            </div>
        </div>
        {{end}}

        {{if or .HasPrev .HasNext}}
        <div class="pagination">
            {{if .HasPrev}}
            <a href="?page={{.PrevPage}}{{if .CurrentTag}}&tag={{.CurrentTag.ID}}{{end}}{{if .Search}}&q={{.Search}}{{end}}{{if .FolderParam}}&folder={{.FolderParam}}{{end}}{{if .PageSizeParam}}&size={{.PageSizeParam}}{{end}}" class="btn btn-outline">ä¸Šä¸€é¡µ</a>
            {{end}}
            <span class="page-info">ç¬¬ {{.Page}} / {{.TotalPages}} é¡µ</span>
            <form method="GET" action="/" class="page-size-form">
                {{if .CurrentTag}}<input type="hidden" name="tag" value="{{.CurrentTag.ID}}">{{end}}
                {{if .Search}}<input type="hidden" name="q" value="{{.Search}}">{{end}}
                {{if .FolderParam}}<input type="hidden" name="folder" value="{{.FolderParam}}">{{end}}
                <label for="page-size-input" class="page-size-label">æ¯é¡µ</label>
                <input type="number" id="page-size-input" name="size" min="5" max="200" value="{{.PageSize}}" class="page-size-input">
                <span class="page-size-unit">æ¡</span>
                <button type="submit" class="btn btn-outline btn-sm">åº”ç”¨</button>
            </form>
            {{if .HasNext}}
            <a href="?page={{.NextPage}}{{if .CurrentTag}}&tag={{.CurrentTag.ID}}{{end}}{{if .Search}}&q={{.Search}}{{end}}{{if .FolderParam}}&folder={{.FolderParam}}{{end}}{{if .PageSizeParam}}&size={{.PageSizeParam}}{{end}}" class="btn btn-outline">ä¸‹ä¸€é¡µ</a>
            {{end}}
        </div>
        {{end}}
        {{else}}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“š</div>
            <h3>æš‚æ— æ”¶è—</h3>
            <p>ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ æ”¶è—"å¼€å§‹æ”¶è—ä½ å–œæ¬¢çš„ç½‘é¡µ</p>
        </div>
        {{end}}
    </div>

    <!-- å³ä¾§åŸŸåé¢æ¿ -->
    <aside class="domain-sidebar" id="domain-sidebar">
        <div class="domain-sidebar-header">
            <h3>åŸŸåç®¡ç†</h3>
            <div class="domain-sidebar-actions">
                <button type="button" class="btn-icon btn-refresh-domain" id="btn-refresh-domain">åˆ·æ–°</button>
                <button type="button" class="btn-icon" id="btn-toggle-domain-sidebar">&lt;</button>
            </div>
        </div>
        <div class="domain-search" id="domain-search-box">
            <input type="text" id="domain-search-input" placeholder="æœç´¢åŸŸå..." class="domain-search-input">
        </div>
        <div class="domain-list" id="domain-list">
            <div class="domain-loading">åŠ è½½ä¸­...</div>
        </div>
    </aside>
</div>

<!-- åŸŸåå‡­è¯ç¼–è¾‘å¼¹çª— -->
<div id="credential-modal" class="modal" style="display:none;">
    <div class="modal-content credential-modal">
        <div class="credential-modal-header">
            <h3>åŸŸåä¿¡æ¯</h3>
            <button type="button" class="btn-icon" id="close-credential-modal">Ã—</button>
        </div>
        <div class="credential-domain-info">
            <div class="credential-domain-name" id="credential-domain"></div>
            <div class="credential-bookmark-count" id="credential-bookmark-count"></div>
        </div>
        <div class="credential-tabs">
            <button type="button" class="credential-tab active" data-tab="credentials">è´¦å·å¯†ç </button>
            <button type="button" class="credential-tab" data-tab="bookmarks">ç›¸å…³ä¹¦ç­¾</button>
        </div>
        <div class="credential-tab-content" id="tab-credentials">
            <!-- è´¦å·åˆ—è¡¨ -->
            <div id="credentials-list"></div>
            <!-- æ·»åŠ æ–°è´¦å·æŒ‰é’® -->
            <button type="button" class="btn btn-outline btn-block" id="add-credential-btn" style="margin-top: 12px;">+ æ·»åŠ æ–°è´¦å·</button>
        </div>
        <div class="credential-tab-content" id="tab-bookmarks" style="display:none;">
            <div class="credential-bookmarks-list" id="credential-bookmarks-list">
                <!-- ä¹¦ç­¾åˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€å¡«å…… -->
            </div>
        </div>
        <div class="modal-actions" style="justify-content: space-between;">
            <button type="button" class="btn btn-outline btn-danger" id="delete-domain-btn">åˆ é™¤æ­¤åŸŸå</button>
            <button type="button" class="btn btn-outline" id="cancel-credential">å…³é—­</button>
        </div>
    </div>
</div>

<!-- åˆ é™¤åŸŸåç¡®è®¤å¼¹çª— -->
<div id="delete-domain-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>ç¡®è®¤åˆ é™¤</h3>
        <p id="delete-domain-message" style="margin: 16px 0; color: var(--text-color);"></p>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
            æ­¤æ“ä½œåªä¼šåˆ é™¤åŸŸåç®¡ç†ä¸­çš„æ•°æ®ï¼ˆè´¦å·å¯†ç ç­‰ï¼‰ï¼Œä¸ä¼šå½±å“æ”¶è—å¤¹ä¸­çš„ä¹¦ç­¾ã€‚
        </p>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" id="cancel-delete-domain">å–æ¶ˆ</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-domain">ç¡®è®¤åˆ é™¤</button>
        </div>
    </div>
</div>

<script>
// å½“å‰æ–‡ä»¶å¤¹è·¯å¾„
var currentFolderPath = '{{.FolderParam}}';
var currentFolderName = '{{if .CurrentFolderName}}{{.CurrentFolderName}}{{else}}æ ¹ç›®å½•{{end}}';

// æ¢å¤ä¾§è¾¹æ æ»šåŠ¨ä½ç½®
(function() {
    var savedScroll = sessionStorage.getItem('sidebarScroll');
    if (savedScroll) {
        var sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            sidebar.scrollTop = parseInt(savedScroll, 10);
        }
    }
})();

// ä¿å­˜ä¾§è¾¹æ æ»šåŠ¨ä½ç½®
document.querySelector('.sidebar').addEventListener('scroll', function() {
    sessionStorage.setItem('sidebarScroll', this.scrollTop);
});

// ç‚¹å‡»é“¾æ¥å‰ä¿å­˜æ»šåŠ¨ä½ç½®
document.querySelectorAll('.sidebar a').forEach(function(link) {
    link.addEventListener('click', function() {
        var sidebar = document.querySelector('.sidebar');
        sessionStorage.setItem('sidebarScroll', sidebar.scrollTop);
    });
});

// æ–‡ä»¶å¤¹å±•å¼€/æ”¶èµ·åŠŸèƒ½
(function() {
    // ä» sessionStorage æ¢å¤å±•å¼€çŠ¶æ€
    var expandedFolders = JSON.parse(sessionStorage.getItem('expandedFolders') || '{}');

    // åº”ç”¨ä¿å­˜çš„å±•å¼€çŠ¶æ€
    document.querySelectorAll('.folder-tree-node').forEach(function(node) {
        var row = node.querySelector('.folder-tree-row');
        if (row) {
            var path = row.getAttribute('data-folder-path');
            if (path && expandedFolders[path]) {
                node.classList.add('open');
            }
        }
    });

    // ç‚¹å‡» caret åˆ‡æ¢å±•å¼€/æ”¶èµ·
    document.querySelectorAll('.folder-caret').forEach(function(caret) {
        if (caret.classList.contains('empty')) return; // æ²¡æœ‰å­æ–‡ä»¶å¤¹çš„ä¸å¤„ç†

        caret.style.cursor = 'pointer';
        caret.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            var node = this.closest('.folder-tree-node');
            var row = node.querySelector('.folder-tree-row');
            var path = row ? row.getAttribute('data-folder-path') : null;

            node.classList.toggle('open');

            // ä¿å­˜å±•å¼€çŠ¶æ€
            if (path) {
                if (node.classList.contains('open')) {
                    expandedFolders[path] = true;
                } else {
                    delete expandedFolders[path];
                }
                sessionStorage.setItem('expandedFolders', JSON.stringify(expandedFolders));
            }
        });
    });
})();

function applySort(value) {
    var url = new URL(window.location.href);
    if (value) {
        url.searchParams.set('sort', value);
    } else {
        url.searchParams.delete('sort');
    }
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

// ç§»åŠ¨ä¹¦ç­¾åŠŸèƒ½
document.getElementById('move-selected').addEventListener('click', function() {
    document.getElementById('move-modal').style.display = 'flex';
});
document.getElementById('cancel-move').addEventListener('click', function() {
    document.getElementById('move-modal').style.display = 'none';
});
document.getElementById('confirm-move').addEventListener('click', function() {
    var targetFolder = document.getElementById('target-folder-input').value;
    var form = document.getElementById('bulk-move-form');
    var checkboxes = document.querySelectorAll('.bookmark-select-input:checked');
    // æ¸…ç©ºæ—§çš„éšè—å­—æ®µ
    form.innerHTML = '';
    checkboxes.forEach(function(cb) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'ids';
        input.value = cb.value;
        form.appendChild(input);
    });
    var folderInput = document.createElement('input');
    folderInput.type = 'hidden';
    folderInput.name = 'target_folder';
    folderInput.value = targetFolder;
    form.appendChild(folderInput);
    form.submit();
});

// æ›´æ–°ç§»åŠ¨æŒ‰é’®çŠ¶æ€
document.querySelectorAll('.bookmark-select-input').forEach(function(cb) {
    cb.addEventListener('change', function() {
        var checked = document.querySelectorAll('.bookmark-select-input:checked').length;
        document.getElementById('move-selected').disabled = checked === 0;
    });
});

// FaviconåŠ è½½åŠŸèƒ½
var faviconCancelled = false;
var faviconMinimized = false;

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡
(function() {
    var state = localStorage.getItem('faviconLoadState');
    if (state) {
        try {
            var data = JSON.parse(state);
            if (data.bookmarks && data.index < data.bookmarks.length) {
                faviconMinimized = true;
                document.getElementById('favicon-float').style.display = 'block';
                updateFaviconProgress(data.index, data.bookmarks.length, 'æ¢å¤åŠ è½½ä¸­...');
                setTimeout(function() {
                    processFavicons(data.bookmarks, data.index, data.bookmarks.length);
                }, 100);
            } else {
                localStorage.removeItem('faviconLoadState');
            }
        } catch (e) {
            localStorage.removeItem('faviconLoadState');
        }
    }
})();

document.getElementById('load-favicons').addEventListener('click', function() {
    faviconCancelled = false;
    faviconMinimized = false;
    localStorage.removeItem('faviconLoadState');
    document.getElementById('favicon-modal').style.display = 'flex';
    document.getElementById('favicon-float').style.display = 'none';
    document.getElementById('favicon-current').textContent = '0';
    document.getElementById('favicon-total').textContent = '0';
    document.getElementById('favicon-progress-bar').style.width = '0%';
    document.getElementById('favicon-status').textContent = 'è·å–å¾…å¤„ç†ä¹¦ç­¾...';
    loadFavicons();
});

document.getElementById('minimize-favicon').addEventListener('click', function() {
    faviconMinimized = true;
    document.getElementById('favicon-modal').style.display = 'none';
    document.getElementById('favicon-float').style.display = 'block';
});

document.getElementById('expand-favicon').addEventListener('click', function() {
    faviconMinimized = false;
    document.getElementById('favicon-modal').style.display = 'flex';
    document.getElementById('favicon-float').style.display = 'none';
});

document.getElementById('cancel-favicon').addEventListener('click', function() {
    faviconCancelled = true;
    localStorage.removeItem('faviconLoadState');
    document.getElementById('favicon-modal').style.display = 'none';
    document.getElementById('favicon-float').style.display = 'none';
});

function loadFavicons() {
    fetch('/api/favicon/pending')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.error) {
                document.getElementById('favicon-status').textContent = 'é”™è¯¯: ' + data.error;
                return;
            }
            var bookmarks = data.bookmarks || [];
            var total = bookmarks.length;
            updateFaviconProgress(0, total, 'å‡†å¤‡å¼€å§‹...');
            if (total === 0) {
                updateFaviconProgress(0, 0, 'æ‰€æœ‰ä¹¦ç­¾å·²æœ‰å›¾æ ‡');
                localStorage.removeItem('faviconLoadState');
                return;
            }
            // ä¿å­˜çŠ¶æ€
            localStorage.setItem('faviconLoadState', JSON.stringify({
                bookmarks: bookmarks,
                index: 0
            }));
            processFavicons(bookmarks, 0, total);
        })
        .catch(function(err) {
            document.getElementById('favicon-status').textContent = 'è¯·æ±‚å¤±è´¥: ' + err;
        });
}

function updateFaviconProgress(current, total, status) {
    var percent = total > 0 ? (current / total * 100) : 0;
    // æ›´æ–°å¼¹çª—
    document.getElementById('favicon-current').textContent = current;
    document.getElementById('favicon-total').textContent = total;
    document.getElementById('favicon-progress-bar').style.width = percent + '%';
    document.getElementById('favicon-status').textContent = status;
    // æ›´æ–°æµ®åŠ¨æ¡
    document.getElementById('favicon-float-text').textContent = current + '/' + total;
    document.getElementById('favicon-float-bar').style.width = percent + '%';
}

function processFavicons(bookmarks, index, total) {
    if (faviconCancelled || index >= total) {
        if (!faviconCancelled) {
            updateFaviconProgress(total, total, 'å®Œæˆï¼');
            localStorage.removeItem('faviconLoadState');
            setTimeout(function() {
                document.getElementById('favicon-modal').style.display = 'none';
                document.getElementById('favicon-float').style.display = 'none';
                location.reload();
            }, 1000);
        }
        return;
    }

    var bm = bookmarks[index];
    var statusText = 'å¤„ç†: ' + bm.url.substring(0, 40) + (bm.url.length > 40 ? '...' : '');
    updateFaviconProgress(index + 1, total, statusText);

    // ä¿å­˜è¿›åº¦åˆ° localStorage
    localStorage.setItem('faviconLoadState', JSON.stringify({
        bookmarks: bookmarks,
        index: index + 1
    }));

    // è·å–favicon URL
    var favicon = getFaviconURL(bm.url);

    // æ›´æ–°åˆ°æœåŠ¡å™¨
    var formData = new FormData();
    formData.append('id', bm.id);
    formData.append('favicon', favicon);

    fetch('/api/favicon/update', {
        method: 'POST',
        body: formData
    })
    .then(function() {
        setTimeout(function() {
            processFavicons(bookmarks, index + 1, total);
        }, 50);
    })
    .catch(function() {
        // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å›¾æ ‡
        formData.set('favicon', '/static/img/default-favicon.png');
        fetch('/api/favicon/update', {
            method: 'POST',
            body: formData
        }).finally(function() {
            setTimeout(function() {
                processFavicons(bookmarks, index + 1, total);
            }, 50);
        });
    });
}

function getFaviconURL(url) {
    try {
        var domain = new URL(url).hostname;
        return 'https://www.google.com/s2/favicons?domain=' + domain + '&sz=32';
    } catch (e) {
        return '/static/img/default-favicon.png';
    }
}

// æ–‡ä»¶å¤¹æ‹–æ”¾åŠŸèƒ½
var dragSourceFolder = null;
var dragTargetFolder = null;

document.querySelectorAll('.folder-tree-row[draggable="true"]').forEach(function(row) {
    row.addEventListener('dragstart', function(e) {
        dragSourceFolder = this.getAttribute('data-folder-path');
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', dragSourceFolder);
    });

    row.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.folder-tree-row').forEach(function(r) {
            r.classList.remove('drag-over');
        });
    });

    row.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        var targetPath = this.getAttribute('data-folder-path');
        // ä¸èƒ½æ‹–åˆ°è‡ªå·±æˆ–è‡ªå·±çš„å­æ–‡ä»¶å¤¹
        if (targetPath !== dragSourceFolder && !targetPath.startsWith(dragSourceFolder + '/')) {
            this.classList.add('drag-over');
        }
    });

    row.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
    });

    row.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        dragTargetFolder = this.getAttribute('data-folder-path');

        if (dragSourceFolder && dragTargetFolder !== dragSourceFolder && !dragTargetFolder.startsWith(dragSourceFolder + '/')) {
            // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
            var sourceName = dragSourceFolder.split('/').pop();
            var targetName = dragTargetFolder.split('/').pop();
            document.getElementById('folder-move-message').textContent =
                'ç¡®å®šè¦å°†æ–‡ä»¶å¤¹ "' + sourceName + '" ç§»åŠ¨åˆ° "' + targetName + '" ä¸‹å—ï¼Ÿ';
            document.getElementById('folder-move-modal').style.display = 'flex';
        }
    });
});

// æ ¹ç›®å½•ä¹Ÿå¯ä»¥ä½œä¸ºæ”¾ç½®ç›®æ ‡
var rootFolderLinks = document.querySelectorAll('.folder-tree-list > .folder-tree-node > .folder-tree-row');
rootFolderLinks.forEach(function(row) {
    if (!row.getAttribute('data-folder-path')) {
        // è¿™æ˜¯"å…¨éƒ¨"æˆ–"æœªåˆ†ç±»"
        row.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (dragSourceFolder) {
                this.classList.add('drag-over');
            }
        });

        row.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });

        row.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            // ç§»åŠ¨åˆ°æ ¹ç›®å½•
            if (dragSourceFolder) {
                dragTargetFolder = '__root__';
                var sourceName = dragSourceFolder.split('/').pop();
                document.getElementById('folder-move-message').textContent =
                    'ç¡®å®šè¦å°†æ–‡ä»¶å¤¹ "' + sourceName + '" ç§»åŠ¨åˆ°æ ¹ç›®å½•å—ï¼Ÿ';
                document.getElementById('folder-move-modal').style.display = 'flex';
            }
        });
    }
});

document.getElementById('cancel-folder-move').addEventListener('click', function() {
    document.getElementById('folder-move-modal').style.display = 'none';
    dragSourceFolder = null;
    dragTargetFolder = null;
});

document.getElementById('confirm-folder-move').addEventListener('click', function() {
    doFolderAction('/api/folder/move');
});

document.getElementById('merge-folder-move').addEventListener('click', function() {
    doFolderAction('/api/folder/merge');
});

function doFolderAction(apiUrl) {
    if (!dragSourceFolder || !dragTargetFolder) {
        document.getElementById('folder-move-modal').style.display = 'none';
        return;
    }

    var formData = new FormData();
    formData.append('source', dragSourceFolder);
    formData.append('target', dragTargetFolder);

    fetch(apiUrl, {
        method: 'POST',
        body: formData
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
        document.getElementById('folder-move-modal').style.display = 'none';
        if (data.success) {
            location.reload();
        } else {
            alert('æ“ä½œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(function(err) {
        document.getElementById('folder-move-modal').style.display = 'none';
        alert('è¯·æ±‚å¤±è´¥: ' + err);
    });

    dragSourceFolder = null;
    dragTargetFolder = null;
}

// å¿«é€Ÿæ·»åŠ åŠŸèƒ½
var quickAddTab = 'bookmark';

document.getElementById('btn-quick-add').addEventListener('click', function() {
    document.getElementById('quick-add-folder-name').textContent = currentFolderName || 'æ ¹ç›®å½•';
    document.getElementById('quick-add-url').value = '';
    document.getElementById('quick-add-title').value = '';
    document.getElementById('quick-add-folder-input').value = '';
    document.getElementById('quick-add-modal').style.display = 'flex';
    document.getElementById('quick-add-url').focus();
});

document.querySelectorAll('.tab-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        quickAddTab = this.getAttribute('data-tab');
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');
        document.getElementById('tab-bookmark').style.display = quickAddTab === 'bookmark' ? 'block' : 'none';
        document.getElementById('tab-folder').style.display = quickAddTab === 'folder' ? 'block' : 'none';
    });
});

document.getElementById('cancel-quick-add').addEventListener('click', function() {
    document.getElementById('quick-add-modal').style.display = 'none';
});

document.getElementById('confirm-quick-add').addEventListener('click', function() {
    if (quickAddTab === 'bookmark') {
        addBookmark();
    } else {
        addFolder();
    }
});

function addBookmark() {
    var url = document.getElementById('quick-add-url').value.trim();
    var title = document.getElementById('quick-add-title').value.trim();

    if (!url) {
        alert('è¯·è¾“å…¥URL');
        return;
    }

    // å¦‚æœæ²¡æœ‰åè®®ï¼Œæ·»åŠ  https://
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
    }

    var formData = new FormData();
    formData.append('url', url);
    formData.append('title', title || url);
    formData.append('folder', currentFolderPath);

    document.getElementById('confirm-quick-add').disabled = true;
    document.getElementById('confirm-quick-add').textContent = 'æ·»åŠ ä¸­...';

    fetch('/api/bookmark/quick-add', {
        method: 'POST',
        body: formData
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
        document.getElementById('confirm-quick-add').disabled = false;
        document.getElementById('confirm-quick-add').textContent = 'ç¡®å®š';
        if (data.success) {
            document.getElementById('quick-add-modal').style.display = 'none';
            location.reload();
        } else {
            alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(function(err) {
        document.getElementById('confirm-quick-add').disabled = false;
        document.getElementById('confirm-quick-add').textContent = 'ç¡®å®š';
        alert('è¯·æ±‚å¤±è´¥: ' + err);
    });
}

function addFolder() {
    var name = document.getElementById('quick-add-folder-input').value.trim() || 'æ–°å»ºæ–‡ä»¶å¤¹';

    var formData = new FormData();
    formData.append('name', name);
    formData.append('parent', currentFolderPath);

    document.getElementById('confirm-quick-add').disabled = true;

    fetch('/api/folder/create', {
        method: 'POST',
        body: formData
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
        document.getElementById('confirm-quick-add').disabled = false;
        if (data.success) {
            document.getElementById('quick-add-modal').style.display = 'none';
            location.reload();
        } else {
            alert('åˆ›å»ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(function(err) {
        document.getElementById('confirm-quick-add').disabled = false;
        alert('è¯·æ±‚å¤±è´¥: ' + err);
    });
}

// ==================== åŸŸåç®¡ç†åŠŸèƒ½ï¼ˆåŸç”Ÿ JavaScriptï¼‰====================
var currentCredentialDomain = '';
var domainData = {
    domains: [],
    loading: true,
    collapsed: localStorage.getItem('domainSidebarCollapsed') === 'true',
    searchKeyword: '',
    openIdx: -1
};

// åˆå§‹åŒ–åŸŸåç®¡ç†
(function() {
    // ç­‰å¾… DOM åŠ è½½å®Œæˆ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDomainManager);
    } else {
        initDomainManager();
    }
})();

function initDomainManager() {
    console.log('åˆå§‹åŒ–åŸŸåç®¡ç†å™¨');

    // åˆå§‹åŒ–æŠ˜å çŠ¶æ€
    if (domainData.collapsed) {
        document.getElementById('domain-sidebar').classList.add('collapsed');
        document.getElementById('btn-toggle-domain-sidebar').textContent = '>';
    }

    // ç»‘å®šäº‹ä»¶
    document.getElementById('btn-refresh-domain').addEventListener('click', function() {
        loadDomainData(true);
    });

    document.getElementById('btn-toggle-domain-sidebar').addEventListener('click', function() {
        domainData.collapsed = !domainData.collapsed;
        localStorage.setItem('domainSidebarCollapsed', domainData.collapsed);
        document.getElementById('domain-sidebar').classList.toggle('collapsed', domainData.collapsed);
        this.textContent = domainData.collapsed ? '>' : '<';
    });

    document.getElementById('domain-search-input').addEventListener('input', function() {
        domainData.searchKeyword = this.value;
        renderDomainList();
    });

    // åŠ è½½æ•°æ®
    loadDomainData(false);
}

function loadDomainData(refresh) {
    domainData.loading = true;
    domainData.openIdx = -1;
    if (refresh) {
        domainData.searchKeyword = '';
        document.getElementById('domain-search-input').value = '';
    }

    var btn = document.getElementById('btn-refresh-domain');
    btn.textContent = 'åˆ·æ–°ä¸­...';
    btn.disabled = true;

    document.getElementById('domain-list').innerHTML = '<div class="domain-loading">åŠ è½½ä¸­...</div>';

    console.log('å¼€å§‹åŠ è½½åŸŸåæ•°æ®...');
    fetch('/api/domain/list' + (refresh ? '?refresh=1' : ''))
        .then(function(r) { return r.json(); })
        .then(function(d) {
            console.log('åŸŸåæ•°æ®åŠ è½½å®Œæˆ:', d);
            domainData.loading = false;
            btn.textContent = 'åˆ·æ–°';
            btn.disabled = false;

            if (d.success && d.domains) {
                domainData.domains = d.domains;
                console.log('åŸŸåæ•°é‡:', domainData.domains.length);
                renderDomainList();
            } else {
                document.getElementById('domain-list').innerHTML = '<div class="domain-empty">åŠ è½½å¤±è´¥</div>';
            }
        })
        .catch(function(err) {
            console.error('åŸŸåæ•°æ®åŠ è½½å¤±è´¥:', err);
            domainData.loading = false;
            btn.textContent = 'åˆ·æ–°';
            btn.disabled = false;
            document.getElementById('domain-list').innerHTML = '<div class="domain-error">åŠ è½½å¤±è´¥: ' + err + '</div>';
        });
}

function getFilteredDomains() {
    if (!domainData.searchKeyword) return domainData.domains;
    var kw = domainData.searchKeyword.toLowerCase();
    var result = [];
    for (var i = 0; i < domainData.domains.length; i++) {
        var g = domainData.domains[i];
        if (g.top_domain.toLowerCase().indexOf(kw) !== -1) {
            result.push(g);
        } else if (g.sub_domains) {
            var matched = [];
            for (var j = 0; j < g.sub_domains.length; j++) {
                if (g.sub_domains[j].toLowerCase().indexOf(kw) !== -1) {
                    matched.push(g.sub_domains[j]);
                }
            }
            if (matched.length > 0) {
                result.push({ top_domain: g.top_domain, sub_domains: matched, bookmark_count: g.bookmark_count });
            }
        }
    }
    return result;
}

function renderDomainList() {
    var container = document.getElementById('domain-list');
    var filtered = getFilteredDomains();

    if (filtered.length === 0) {
        container.innerHTML = '<div class="domain-empty">æš‚æ— åŸŸå</div>';
        return;
    }

    var html = '';
    for (var i = 0; i < filtered.length; i++) {
        var g = filtered[i];
        var hasSubs = g.sub_domains && g.sub_domains.length > 0;
        var isOpen = domainData.openIdx === i;
        var caret = hasSubs ? (isOpen ? 'v' : '>') : '-';
        var countText = '(' + g.bookmark_count + (hasSubs ? '/' + g.sub_domains.length : '') + ')';

        html += '<div class="domain-group-item">';
        html += '<div class="domain-group-header" data-idx="' + i + '">';
        html += '<span class="domain-group-caret">' + caret + '</span>';
        html += '<span class="domain-group-name">' + escapeHtml(g.top_domain) + '</span>';
        html += '<span class="domain-group-count">' + countText + '</span>';
        html += '<span class="btn-domain-edit" data-domain="' + escapeHtml(g.top_domain) + '">[ç®¡ç†]</span>';
        html += '</div>';

        if (isOpen && hasSubs) {
            html += '<div class="domain-sublist">';
            for (var j = 0; j < g.sub_domains.length; j++) {
                var sub = g.sub_domains[j];
                html += '<div class="domain-subitem">';
                html += '<span class="domain-subitem-name">' + escapeHtml(sub) + '</span>';
                html += '<span class="btn-domain-edit" data-domain="' + escapeHtml(sub) + '">[ç®¡ç†]</span>';
                html += '</div>';
            }
            html += '</div>';
        }
        html += '</div>';
    }

    container.innerHTML = html;

    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    container.querySelectorAll('.domain-group-header').forEach(function(el) {
        el.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-domain-edit')) return;
            var idx = parseInt(this.getAttribute('data-idx'));
            domainData.openIdx = domainData.openIdx === idx ? -1 : idx;
            renderDomainList();
        });
    });

    container.querySelectorAll('.btn-domain-edit').forEach(function(el) {
        el.addEventListener('click', function(e) {
            e.stopPropagation();
            var domain = this.getAttribute('data-domain');
            openCredentialModal(domain);
        });
    });
}

// æ‰“å¼€å‡­è¯ç¼–è¾‘å¼¹çª—
var credentialBookmarksLoaded = false; // æ ‡è®°ä¹¦ç­¾æ˜¯å¦å·²åŠ è½½
var currentCredentials = []; // å½“å‰åŸŸåçš„æ‰€æœ‰å‡­è¯

function openCredentialModal(domain) {
    currentCredentialDomain = domain;
    credentialBookmarksLoaded = false;
    currentCredentials = [];
    document.getElementById('credential-domain').textContent = domain;
    document.getElementById('credential-modal').style.display = 'flex';
    document.getElementById('credentials-list').innerHTML = '<div class="domain-loading">åŠ è½½ä¸­...</div>';
    document.getElementById('credential-bookmarks-list').innerHTML = '<div class="domain-loading">ç‚¹å‡»æ ‡ç­¾åŠ è½½ä¹¦ç­¾...</div>';
    document.getElementById('credential-bookmark-count').textContent = '';

    // åˆ‡æ¢åˆ°å‡­è¯æ ‡ç­¾
    switchCredentialTab('credentials');

    // åŠ è½½å‡­è¯æ•°æ®
    fetch('/api/domain/credential?domain=' + encodeURIComponent(domain) + '&no_bookmarks=1')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                currentCredentials = data.credentials || [];
                renderCredentialsList();
            } else {
                document.getElementById('credentials-list').innerHTML = '<div class="domain-error">åŠ è½½å¤±è´¥</div>';
            }
        })
        .catch(function(err) {
            console.error('åŠ è½½å‡­è¯å¤±è´¥:', err);
            document.getElementById('credentials-list').innerHTML = '<div class="domain-error">åŠ è½½å¤±è´¥: ' + err + '</div>';
        });
}

// æ¸²æŸ“å‡­è¯åˆ—è¡¨
function renderCredentialsList() {
    var container = document.getElementById('credentials-list');

    if (currentCredentials.length === 0) {
        container.innerHTML = '<div class="domain-empty">æš‚æ— ä¿å­˜çš„è´¦å·ä¿¡æ¯</div>';
        return;
    }

    var html = '';
    for (var i = 0; i < currentCredentials.length; i++) {
        var cred = currentCredentials[i];
        html += renderCredentialCard(cred, i);
    }
    container.innerHTML = html;

    // ç»‘å®šäº‹ä»¶
    bindCredentialCardEvents();
}

// æ¸²æŸ“å•ä¸ªå‡­è¯å¡ç‰‡
function renderCredentialCard(cred, index) {
    var title = cred.title || 'è´¦å· ' + (index + 1);
    var html = '<div class="credential-card" data-id="' + cred.id + '" data-index="' + index + '">';
    html += '<div class="credential-card-header">';
    html += '<span class="credential-card-title">' + escapeHtml(title) + '</span>';
    html += '<div class="credential-card-actions">';
    html += '<button type="button" class="btn-icon btn-edit-cred" title="ç¼–è¾‘">âœï¸</button>';
    html += '<button type="button" class="btn-icon btn-delete-cred btn-danger" title="åˆ é™¤">ğŸ—‘ï¸</button>';
    html += '</div>';
    html += '</div>';
    html += '<div class="credential-card-body">';
    html += '<div class="credential-field">';
    html += '<span class="credential-field-label">ç”¨æˆ·å:</span>';
    html += '<span class="credential-field-value">' + escapeHtml(cred.username || '-') + '</span>';
    html += '<button type="button" class="btn-copy-small" data-value="' + escapeHtml(cred.username || '') + '">å¤åˆ¶</button>';
    html += '</div>';
    html += '<div class="credential-field">';
    html += '<span class="credential-field-label">å¯†ç :</span>';
    html += '<span class="credential-field-value credential-password-masked">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>';
    html += '<button type="button" class="btn-show-pwd" data-pwd="' + escapeHtml(cred.password || '') + '">æ˜¾ç¤º</button>';
    html += '<button type="button" class="btn-copy-small" data-value="' + escapeHtml(cred.password || '') + '">å¤åˆ¶</button>';
    html += '</div>';
    if (cred.notes) {
        html += '<div class="credential-field credential-notes-field">';
        html += '<span class="credential-field-label">å¤‡æ³¨:</span>';
        html += '<span class="credential-field-value credential-notes-text">' + escapeHtml(cred.notes) + '</span>';
        html += '</div>';
    }
    html += '</div>';
    html += '</div>';
    return html;
}

// ç»‘å®šå‡­è¯å¡ç‰‡äº‹ä»¶
function bindCredentialCardEvents() {
    // å¤åˆ¶æŒ‰é’®
    document.querySelectorAll('.btn-copy-small').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var value = this.getAttribute('data-value');
            copyToClipboard(value, this);
        });
    });

    // æ˜¾ç¤ºå¯†ç æŒ‰é’®
    document.querySelectorAll('.btn-show-pwd').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var pwd = this.getAttribute('data-pwd');
            var valueSpan = this.parentElement.querySelector('.credential-password-masked');
            if (this.textContent === 'æ˜¾ç¤º') {
                valueSpan.textContent = pwd || '-';
                this.textContent = 'éšè—';
            } else {
                valueSpan.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                this.textContent = 'æ˜¾ç¤º';
            }
        });
    });

    // ç¼–è¾‘æŒ‰é’®
    document.querySelectorAll('.btn-edit-cred').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var card = this.closest('.credential-card');
            var index = parseInt(card.getAttribute('data-index'));
            editCredential(index);
        });
    });

    // åˆ é™¤æŒ‰é’®
    document.querySelectorAll('.btn-delete-cred').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var card = this.closest('.credential-card');
            var id = parseInt(card.getAttribute('data-id'));
            deleteCredential(id);
        });
    });
}

// å¤åˆ¶åˆ°å‰ªè´´æ¿
function copyToClipboard(text, btn) {
    navigator.clipboard.writeText(text).then(function() {
        var originalText = btn.textContent;
        btn.textContent = 'å·²å¤åˆ¶';
        setTimeout(function() { btn.textContent = originalText; }, 1000);
    }).catch(function() {
        // é™çº§æ–¹æ¡ˆ
        var textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        var originalText = btn.textContent;
        btn.textContent = 'å·²å¤åˆ¶';
        setTimeout(function() { btn.textContent = originalText; }, 1000);
    });
}

// ç¼–è¾‘å‡­è¯
function editCredential(index) {
    var cred = currentCredentials[index];
    showCredentialForm(cred);
}

// åˆ é™¤å‡­è¯
function deleteCredential(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·ä¿¡æ¯å—ï¼Ÿ')) return;

    var formData = new FormData();
    formData.append('id', id);

    fetch('/api/domain/credential/delete', {
        method: 'POST',
        body: formData
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
        if (data.success) {
            // ä»åˆ—è¡¨ä¸­ç§»é™¤
            currentCredentials = currentCredentials.filter(function(c) { return c.id !== id; });
            renderCredentialsList();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(function(err) {
        alert('è¯·æ±‚å¤±è´¥: ' + err);
    });
}

// æ˜¾ç¤ºå‡­è¯ç¼–è¾‘è¡¨å•
var editingCredentialId = null;

function showCredentialForm(cred) {
    editingCredentialId = cred ? cred.id : null;
    var container = document.getElementById('credentials-list');

    var html = '<div class="credential-form">';
    html += '<div class="form-group">';
    html += '<label>å¤‡æ³¨æ ‡é¢˜</label>';
    html += '<input type="text" id="edit-cred-title" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œè´¦å·" class="form-input" value="' + escapeHtml(cred ? cred.title || '' : '') + '">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label>ç”¨æˆ·å / é‚®ç®±</label>';
    html += '<input type="text" id="edit-cred-username" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±" class="form-input" value="' + escapeHtml(cred ? cred.username || '' : '') + '">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label>å¯†ç </label>';
    html += '<input type="text" id="edit-cred-password" placeholder="è¾“å…¥å¯†ç " class="form-input" value="' + escapeHtml(cred ? cred.password || '' : '') + '">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label>å¤‡æ³¨</label>';
    html += '<textarea id="edit-cred-notes" placeholder="å…¶ä»–å¤‡æ³¨ä¿¡æ¯" class="form-input" rows="3">' + escapeHtml(cred ? cred.notes || '' : '') + '</textarea>';
    html += '</div>';
    html += '<div class="form-actions">';
    html += '<button type="button" class="btn btn-outline" id="cancel-edit-cred">å–æ¶ˆ</button>';
    html += '<button type="button" class="btn btn-primary" id="save-edit-cred">ä¿å­˜</button>';
    html += '</div>';
    html += '</div>';

    container.innerHTML = html;

    // ç»‘å®šäº‹ä»¶
    document.getElementById('cancel-edit-cred').addEventListener('click', function() {
        renderCredentialsList();
    });

    document.getElementById('save-edit-cred').addEventListener('click', function() {
        saveCredentialForm();
    });
}

// ä¿å­˜å‡­è¯è¡¨å•
function saveCredentialForm() {
    var title = document.getElementById('edit-cred-title').value;
    var username = document.getElementById('edit-cred-username').value;
    var password = document.getElementById('edit-cred-password').value;
    var notes = document.getElementById('edit-cred-notes').value;

    var formData = new FormData();
    formData.append('title', title);
    formData.append('username', username);
    formData.append('password', password);
    formData.append('notes', notes);

    var url, isNew;
    if (editingCredentialId) {
        formData.append('id', editingCredentialId);
        url = '/api/domain/credential/update';
        isNew = false;
    } else {
        formData.append('domain', currentCredentialDomain);
        url = '/api/domain/credential/save';
        isNew = true;
    }

    var btn = document.getElementById('save-edit-cred');
    btn.disabled = true;
    btn.textContent = 'ä¿å­˜ä¸­...';

    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
        btn.disabled = false;
        btn.textContent = 'ä¿å­˜';
        if (data.success) {
            // é‡æ–°åŠ è½½å‡­è¯åˆ—è¡¨
            openCredentialModal(currentCredentialDomain);
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'ä¿å­˜';
        alert('è¯·æ±‚å¤±è´¥: ' + err);
    });
}

// æ·»åŠ æ–°è´¦å·æŒ‰é’®
document.getElementById('add-credential-btn').addEventListener('click', function() {
    showCredentialForm(null);
});

// æ‡’åŠ è½½ä¹¦ç­¾æ•°æ®
function loadCredentialBookmarks() {
    if (credentialBookmarksLoaded || !currentCredentialDomain) return;

    document.getElementById('credential-bookmarks-list').innerHTML = '<div class="domain-loading">åŠ è½½ä¸­...</div>';

    fetch('/api/domain/credential?domain=' + encodeURIComponent(currentCredentialDomain))
        .then(function(res) { return res.json(); })
        .then(function(data) {
            credentialBookmarksLoaded = true;
            if (data.success) {
                var bookmarks = data.bookmarks || [];
                document.getElementById('credential-bookmark-count').textContent = bookmarks.length + ' ä¸ªç›¸å…³ä¹¦ç­¾';
                renderCredentialBookmarks(bookmarks);
            } else {
                document.getElementById('credential-bookmarks-list').innerHTML = '<div class="domain-error">åŠ è½½å¤±è´¥</div>';
            }
        })
        .catch(function(err) {
            console.error('åŠ è½½ä¹¦ç­¾å¤±è´¥:', err);
            document.getElementById('credential-bookmarks-list').innerHTML = '<div class="domain-error">åŠ è½½å¤±è´¥: ' + err + '</div>';
        });
}

// æ¸²æŸ“å‡­è¯ç›¸å…³çš„ä¹¦ç­¾åˆ—è¡¨
function renderCredentialBookmarks(bookmarks) {
    var container = document.getElementById('credential-bookmarks-list');
    if (bookmarks.length === 0) {
        container.innerHTML = '<div class="domain-empty">æš‚æ— ç›¸å…³ä¹¦ç­¾</div>';
        return;
    }

    var html = '';
    bookmarks.forEach(function(bm) {
        var shortUrl = truncateUrl(bm.url, 50);
        html += '<div class="credential-bookmark-item">';
        html += '<img src="' + (bm.favicon || '/static/img/default-favicon.png') + '" class="credential-bookmark-favicon" onerror="this.src=\'/static/img/default-favicon.png\'">';
        html += '<div class="credential-bookmark-info">';
        html += '<a href="' + escapeHtml(bm.url) + '" target="_blank" class="credential-bookmark-title">' + escapeHtml(bm.title || 'æ— æ ‡é¢˜') + '</a>';
        html += '<div class="credential-bookmark-url" title="' + escapeHtml(bm.url) + '">' + escapeHtml(shortUrl) + '</div>';
        html += '</div>';
        html += '</div>';
    });
    container.innerHTML = html;
}

// URL æˆªæ–­å‡½æ•°
function truncateUrl(url, maxLen) {
    if (!url || url.length <= maxLen) return url;
    var shortUrl = url.replace(/^https?:\/\//, '');
    if (shortUrl.length <= maxLen) return shortUrl;
    return shortUrl.substring(0, maxLen - 3) + '...';
}

// åˆ‡æ¢å‡­è¯å¼¹çª—æ ‡ç­¾
function switchCredentialTab(tab) {
    document.querySelectorAll('.credential-tab').forEach(function(t) {
        t.classList.toggle('active', t.getAttribute('data-tab') === tab);
    });
    document.getElementById('tab-credentials').style.display = tab === 'credentials' ? 'block' : 'none';
    document.getElementById('tab-bookmarks').style.display = tab === 'bookmarks' ? 'block' : 'none';

    if (tab === 'bookmarks') {
        loadCredentialBookmarks();
    }
}

// å‡­è¯æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
document.querySelectorAll('.credential-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
        switchCredentialTab(this.getAttribute('data-tab'));
    });
});

// å…³é—­å‡­è¯å¼¹çª—
document.getElementById('close-credential-modal').addEventListener('click', function() {
    document.getElementById('credential-modal').style.display = 'none';
});
document.getElementById('cancel-credential').addEventListener('click', function() {
    document.getElementById('credential-modal').style.display = 'none';
});

// åˆ é™¤åŸŸååŠŸèƒ½
document.getElementById('delete-domain-btn').addEventListener('click', function() {
    document.getElementById('delete-domain-message').textContent =
        'ç¡®å®šè¦åˆ é™¤åŸŸå "' + currentCredentialDomain + '" çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ';
    document.getElementById('delete-domain-modal').style.display = 'flex';
});

document.getElementById('cancel-delete-domain').addEventListener('click', function() {
    document.getElementById('delete-domain-modal').style.display = 'none';
});

document.getElementById('confirm-delete-domain').addEventListener('click', function() {
    var btn = this;
    btn.disabled = true;
    btn.textContent = 'åˆ é™¤ä¸­...';

    var formData = new FormData();
    formData.append('domain', currentCredentialDomain);

    fetch('/api/domain/delete', {
        method: 'POST',
        body: formData
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
        btn.disabled = false;
        btn.textContent = 'ç¡®è®¤åˆ é™¤';
        if (data.success) {
            document.getElementById('delete-domain-modal').style.display = 'none';
            document.getElementById('credential-modal').style.display = 'none';
            // åˆ·æ–°åŸŸååˆ—è¡¨
            loadDomainData(false);
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'ç¡®è®¤åˆ é™¤';
        alert('è¯·æ±‚å¤±è´¥: ' + err);
    });
});

// HTML è½¬ä¹‰å‡½æ•°ï¼ˆçº¯å­—ç¬¦ä¸²æ›¿æ¢ï¼Œé«˜æ€§èƒ½ï¼‰
function escapeHtml(text) {
    if (!text) return '';
    return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}
</script>
{{end}}

{{define "folder_nodes"}}
{{range .}}
<li class="folder-tree-node {{if .Open}}open{{end}}">
    <div class="folder-tree-row" draggable="true" data-folder-path="{{.Path}}">
        {{if .Children}}
        <span class="folder-caret"></span>
        {{else}}
        <span class="folder-caret empty"></span>
        {{end}}
        <a href="/?folder={{.EncodedPath}}{{if .PageSizeParam}}&size={{.PageSizeParam}}{{end}}" class="folder-link {{if .Active}}active{{end}}">{{.Name}}</a>
    </div>
    {{if .Children}}
    <ul class="folder-tree-list">
        {{template "folder_nodes" .Children}}
    </ul>
    {{end}}
</li>
{{end}}
{{end}}
